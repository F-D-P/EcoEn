{% extends "base.html" %}
{% load static %}

{% block header_title %}
  <h1 class="text-center m-0">üõí Carrito de Compras</h1>
{% endblock %}

{% block content %}
<section class="container py-5">
  <h2 class="text-center mb-4">Detalle del carrito</h2>

  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead class="table-dark">
        <tr>
          <th>Producto</th>
          <th>Precio (ARS)</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody id="carrito-body"></tbody>
    </table>
  </div>

  <div class="text-end mt-3">
    <h4>Total: <span id="total" class="fw-bold text-success">$0</span> ARS</h4>
  </div>

  <div id="carrito-vacio" class="alert alert-info text-center d-none mt-4">
    üõçÔ∏è Tu carrito est√° vac√≠o. ¬°Agrega productos para comenzar!
  </div>

  <!-- Selector de m√©todo de pago -->
  <div class="mt-4">
    <label for="metodo-pago" class="form-label fw-bold">Selecciona m√©todo de pago:</label>
    <select id="metodo-pago" class="form-select w-auto">
      <option value="mercado-pago">Mercado Pago</option>
      <option value="efectivo">Efectivo</option>
    </select>
  </div>

  <!-- Bot√≥n de confirmaci√≥n -->
  <div class="mt-4 text-end">
    <button id="confirmar-compra" class="btn btn-primary fw-bold">
      ‚úÖ Confirmar compra
    </button>
  </div>
</section>

<script>
  // Funci√≥n para abrir/cerrar men√∫ hamburguesa
  function toggleMenu() {
    const menu = document.getElementById("menu-lateral");
    const overlay = document.getElementById("menu-overlay");
    const expanded = menu.classList.contains("active");

    menu.classList.toggle("active");
    overlay.classList.toggle("active");

    document.getElementById("menu-toggle").setAttribute("aria-expanded", !expanded);
  }

  const tbody = document.getElementById("carrito-body");
  const totalElement = document.getElementById("total");
  const carritoVacio = document.getElementById("carrito-vacio");
  const metodoPago = document.getElementById("metodo-pago");
  const confirmarBtn = document.getElementById("confirmar-compra");

  const formatoARS = new Intl.NumberFormat("es-AR", {
    style: "currency",
    currency: "ARS",
    minimumFractionDigits: 2
  });

  function obtenerCarrito() {
    return JSON.parse(localStorage.getItem("carrito")) || [];
  }

  function guardarCarrito(carrito) {
    localStorage.setItem("carrito", JSON.stringify(carrito));
  }

  function mostrarCarrito() {
    const carrito = obtenerCarrito();
    tbody.innerHTML = "";
    let total = 0;

    if (carrito.length === 0) {
      carritoVacio.classList.remove("d-none");
      totalElement.textContent = formatoARS.format(0);
      return;
    } else {
      carritoVacio.classList.add("d-none");
    }

    carrito.forEach((item, index) => {
      const subtotal = item.precio * item.cantidad;
      total += subtotal;

      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${item.nombre}</td>
        <td>${formatoARS.format(item.precio)}</td>
        <td>
          <div class="d-flex align-items-center justify-content-center">
            <button class="btn btn-outline-secondary btn-sm me-2" onclick="cambiarCantidad(${index}, -1)">‚ûñ</button>
            <span class="fw-bold">${item.cantidad}</span>
            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="cambiarCantidad(${index}, 1)">‚ûï</button>
          </div>
        </td>
        <td>${formatoARS.format(subtotal)}</td>
        <td>
          <button class="btn btn-danger btn-sm" onclick="eliminarDelCarrito(${index})">‚ùå Eliminar</button>
        </td>
      `;
      tbody.appendChild(fila);
    });

    totalElement.textContent = formatoARS.format(total);
  }

  function cambiarCantidad(index, cambio) {
    const carrito = obtenerCarrito();
    carrito[index].cantidad += cambio;

    if (carrito[index].cantidad <= 0) {
      eliminarDelCarrito(index);
    } else {
      guardarCarrito(carrito);
      mostrarCarrito();
    }
  }

  function eliminarDelCarrito(index) {
    const carrito = obtenerCarrito();
    if (confirm("¬øSeguro que deseas eliminar este producto?")) {
      carrito.splice(index, 1);
      guardarCarrito(carrito);
      mostrarCarrito();
    }
  }

  confirmarBtn.addEventListener("click", () => {
    const metodo = metodoPago.value;
    const carrito = obtenerCarrito();

    if (carrito.length === 0) {
      alert("Tu carrito est√° vac√≠o.");
      return;
    }

    localStorage.setItem("metodo_pago", metodo);
    window.location.href = "/resumen/";
  });

  document.addEventListener("DOMContentLoaded", mostrarCarrito);
</script>
{% endblock %}
